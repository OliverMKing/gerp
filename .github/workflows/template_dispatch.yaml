name: Template dispatch

on:
  workflow_call:

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setVariables.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3
      - id: setVariables
        run: |
          repos=$(jq '.repos | keys' -c .gerp/config.json)
          echo "::set-output name=matrix::$repos"
  dispatch:
    needs: setup
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{fromJson(needs.setup.outputs.matrix)}}
    steps:
      - uses: actions/checkout@v3
      - name: Install Mustache
        run: npm install -g mustache
      - name: Generate files
        run: |
          repo=${{ matrix.repo }}
          jq --arg repo "$repo" '.repos[$repo].inputs' ./.gerp/config.json > inputs.json
          for f in $(find ./template -type f); do
            outpath=generated/${f#./*/}
            mkdir -p $(dirname $outpath) && touch $outpath
            mustache inputs.json $f > $outpath
            echo generated $outpath
          done
